---
title: Core Concepts
description: How AuthRail evaluates middleware.
---

import { CodeBlock } from "fumadocs-ui/components/codeblock";

AuthRail is built around three primitives:

- Rail
- Middleware
- Decision

Understanding these explains the entire system.

---

## Rail

A rail is a named collection of ordered middleware.

<CodeBlock>
```ts
createRail<Ctx>(name: string, middleware: Middleware<Ctx>[])
```
</CodeBlock>

A rail does not execute automatically.
It must be evaluated explicitly:

<CodeBlock>```ts await rail.evaluate(context); ```</CodeBlock>

Each evaluation is independent.

---

## Middleware

Middleware is a function that receives context and may return:

<CodeBlock>
```ts
type MiddlewareResult<Ctx> = {
  decision?: {
    type: "allow" | "deny" | "redirect";
    to?: string;
  };
  context?: Partial<Ctx>;
};
```
</CodeBlock>

Signature:

<CodeBlock>
```ts
type Middleware<Ctx> = (
  ctx: Readonly<Ctx>
) => Promise<MiddlewareResult<Ctx> | void> | MiddlewareResult<Ctx> | void;
```
</CodeBlock>

Middleware can:

- return nothing → continue
- return `decision` → short-circuit
- return `context` → enrich context

---

## Execution Order

Middleware runs strictly in array order.

Given:

<CodeBlock>
  ```ts createRail("example", [ middlewareA, middlewareB, middlewareC, ]); ```
</CodeBlock>

Execution flow:

1. `middlewareA`
2. `middlewareB`
3. `middlewareC`

If `middlewareA` returns `deny`,  
`middlewareB` and `middlewareC` will not execute.

There is no parallelism.
There is no reordering.

---

## Context Enrichment

Middleware may return additional context:

<CodeBlock>
```ts
return {
  context: { permissions }
};
```
</CodeBlock>

Returned context is shallow-merged into the working context before the next middleware runs.

Example:

<CodeBlock>
```ts
initialContext = { user }
middleware1 returns { context: { permissions } }

next middleware receives:
{ user, permissions }

````
</CodeBlock>

---

## Default Behavior

If no middleware returns a blocking decision,
the final decision is:

<CodeBlock>
```ts
{ type: "allow" }
````

</CodeBlock>

---

## Evaluation Output

Every evaluation returns:

<CodeBlock>
```ts
{
  decision: {
    type: "allow" | "deny" | "redirect",
    to?: string
  },
  context: Ctx
}
```
</CodeBlock>

`context` reflects any enrichment performed during execution.
